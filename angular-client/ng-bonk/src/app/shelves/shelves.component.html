<mat-toolbar id="toolbar-shelves" class="gap-2">
  <button mat-icon-button>
    <mat-icon>tune</mat-icon>
  </button>
  <button mat-icon-button (click)="refresh()">
    <mat-icon>refresh</mat-icon>
  </button>
  <button mat-icon-button>
    <mat-icon>filter_alt</mat-icon>
  </button>
  <div class="toolbar-divider">&nbsp;</div>
  <button mat-button (click)="openCreateDialog()">
    <mat-icon>shelves</mat-icon>
    Add Shelf
  </button>
  <div class="toolbar-divider">&nbsp;</div>
  <button mat-button (click)="openBookSearchDialog()">
    <mat-icon>book_ribbon</mat-icon>
    Add Book
  </button>
  <!--Divider, then TODO: chits for categories.-->
  <div class="spacer"></div>
  <mat-paginator
    [length]="total"
    [pageSize]="10"
    [pageSizeOptions]="[5, 10, 25]"
    aria-label="Shelf Pagination">
  </mat-paginator>
</mat-toolbar>

<div *ngIf="loading$ | async">
  <mat-progress-bar mode="indeterminate" />
</div>

<!-- Main shelves table -->
<div class="shelves-container">
  <!-- No Data -->
  <div
    class="table-no-data-bar"
    *ngIf="(dataSource.connect() | async)?.length === 0">
    You do not currently have any shelves. This should not be possible.
  </div>

  <!-- Shelves with expansion panels -->
  <mat-accordion class="shelves-accordion" multi>
    <mat-expansion-panel
      *ngFor="let shelf of dataSource.connect() | async"
      [expanded]="expandedShelf === shelf.id"
      (opened)="toggleExpand(shelf.id)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          {{ shelf.title }}
        </mat-panel-title>
        <mat-panel-description>
          <span class="shelf-date">{{
            shelf.createdDate | date: 'short'
          }}</span>
          <span *ngIf="shelf.defaultShelf" class="default-badge">Default</span>
          <div class="shelf-actions">
            <button
              *ngIf="!shelf.defaultShelf"
              mat-icon-button
              matTooltip="Delete shelf"
              (click)="deleteShelf(shelf.id, $event)">
              <mat-icon color="warn">delete</mat-icon>
            </button>
            <button
              *ngIf="!shelf.defaultShelf"
              mat-icon-button
              matTooltip="Edit shelf"
              (click)="openEditDialog(shelf.id, $event)">
              <mat-icon color="primary">edit</mat-icon>
            </button>
          </div>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <!-- Books table inside the expansion panel -->
      <div class="books-container">
        <div *ngIf="loadingBooks[shelf.id]" class="loading-books">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </div>

        <div
          *ngIf="
            !loadingBooks[shelf.id] &&
            (!shelfBooks[shelf.id] || shelfBooks[shelf.id].length === 0)
          "
          class="no-books-message">
          This shelf has no books yet.
        </div>

        <table
          mat-table
          [dataSource]="shelfBooks[shelf.id] || []"
          *ngIf="
            !loadingBooks[shelf.id] &&
            shelfBooks[shelf.id] &&
            shelfBooks[shelf.id].length > 0
          "
          class="books-table mat-elevation-z0">
          <!-- Cover Column -->
          <ng-container matColumnDef="cover">
            <th mat-header-cell *matHeaderCellDef>Cover</th>
            <td mat-cell *matCellDef="let book">
              <div class="book-cover-avatar" (click)="openBookDetails(book)">
                <img [src]="book.imageURL" alt="{{ book.title }} cover" />
              </div>
            </td>
          </ng-container>

          <!-- Title Column -->
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>Title</th>
            <td mat-cell *matCellDef="let book" (click)="openBookDetails(book)">
              {{ book.title }}
            </td>
          </ng-container>

          <!-- Author Column -->
          <ng-container matColumnDef="author">
            <th mat-header-cell *matHeaderCellDef>Author</th>
            <td mat-cell *matCellDef="let book" (click)="openBookDetails(book)">
              {{ book.author }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let book">
              <button
                mat-icon-button
                [matMenuTriggerFor]="bookMenu"
                aria-label="Book options">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #bookMenu="matMenu">
                <button mat-menu-item (click)="openBookDetails(book)">
                  <mat-icon>info</mat-icon>
                  <span>Details</span>
                </button>
                <button mat-menu-item (click)="nominateBook(book, $event)">
                  <mat-icon>star</mat-icon>
                  <span>Nominate</span>
                </button>
                <button
                  mat-menu-item
                  (click)="removeBookFromShelf(book.id, shelf.id, $event)">
                  <mat-icon>remove_circle</mat-icon>
                  <span>Remove from shelf</span>
                </button>
                <button mat-menu-item (click)="deleteBook(book.id, $event)">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>Delete book</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="bookColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: bookColumns"
            class="book-row"></tr>
        </table>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>
