@if (election$ | async; as election) {
  @let closed = isElectionClosed(election);
  @let chip = statusChip(election);
  @let latest = latestResult$ | async;
  @let results = results$ | async;
  @let myNomination = myNominationId$ | async;
  @let isHandset = (isHandset$ | async) === true;
  @let runningNow = (running$ | async) === true;
  @let submittingNow = (submitting$ | async) === true;
  @let loadingElection = (loadingElection$ | async) === true;
  @let loadingCandidates = (loadingCandidates$ | async) === true;
  @let loadingResults = (loadingResults$ | async) === true;
  @let saving = (savingElection$ | async) === true;
  @let reopening = (reopeningElection$ | async) === true;
  <div class="election-detail">
    <mat-toolbar id="toolbar-election-detail" class="gap-2">
      <button
        mat-icon-button
        routerLink="/elections"
        aria-label="Back to elections">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="title">{{ election.title }}</span>
      <span class="spacer"></span>
      <mat-chip class="status-chip" [ngClass]="chip.class">
        <mat-icon matChipAvatar>{{ chip.icon }}</mat-icon>
        {{ chip.label }}
      </mat-chip>
      @if (!closed && election.endDateTime) {
        <mat-chip class="status-chip soft">
          <mat-icon matChipAvatar>event</mat-icon>
          Closes: {{ election.endDateTime | date: 'short' }}
        </mat-chip>
      }
      @if (closed && latest?.closureTime) {
        <mat-chip class="status-chip soft">
          <mat-icon matChipAvatar>event_available</mat-icon>
          Closed: {{ latest?.closureTime | date: 'short' }}
        </mat-chip>
      }
    </mat-toolbar>

    <mat-toolbar id="toolbar-election-actions" class="gap-2">
      <span>Controls</span>
      <span class="spacer"></span>

      @if (!isHandset) {
        @if (!closed) {
          @if (!myNomination) {
            <button
              mat-stroked-button
              (click)="openNominateSearch()"
              [disabled]="ballotLocked">
              <mat-icon>library_add</mat-icon>
              Search &amp; nominate
            </button>
            <button
              mat-stroked-button
              (click)="openNominateDialog()"
              [disabled]="ballotLocked">
              <mat-icon>star</mat-icon>
              Nominate from shelf
            </button>
          } @else {
            <button
              mat-button
              color="warn"
              (click)="removeMyNomination(myNomination)">
              <mat-icon>remove_circle</mat-icon>
              Remove nomination
            </button>
          }
          <button
            mat-flat-button
            color="accent"
            (click)="runElection()"
            [disabled]="runningNow">
            <mat-icon>play_arrow</mat-icon>
            {{ runningNow ? 'Running…' : 'Run election' }}
          </button>
          <button
            mat-stroked-button
            (click)="openEditDialog(election)"
            [disabled]="saving">
            <mat-icon>edit</mat-icon>
            {{ saving ? 'Saving…' : 'Edit' }}
          </button>
          <button
            mat-stroked-button
            color="warn"
            (click)="confirmDelete(election)">
            <mat-icon>delete</mat-icon>
            Delete
          </button>
        } @else {
          <button
            mat-flat-button
            color="accent"
            (click)="openReopenDialog(election)"
            [disabled]="reopening">
            <mat-icon>restart_alt</mat-icon>
            {{ reopening ? 'Reopening…' : 'Reopen' }}
          </button>
          <button
            mat-stroked-button
            color="warn"
            (click)="confirmDelete(election)">
            <mat-icon>delete</mat-icon>
            Delete
          </button>
        }
      } @else {
        <button
          mat-icon-button
          [matMenuTriggerFor]="actionsMenu"
          aria-label="Actions">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #actionsMenu="matMenu">
          @if (!closed) {
          @if (!myNomination) {
              <button
                mat-menu-item
                (click)="openNominateSearch()"
                [disabled]="ballotLocked">
                <mat-icon>library_add</mat-icon>
                <span>Search &amp; nominate</span>
              </button>
              <button
                mat-menu-item
                (click)="openNominateDialog()"
                [disabled]="ballotLocked">
                <mat-icon>star</mat-icon>
                <span>Nominate from shelf</span>
              </button>
            } @else {
              <button mat-menu-item (click)="removeMyNomination(myNomination)">
                <mat-icon>remove_circle</mat-icon>
                <span>Remove nomination</span>
              </button>
            }
            <button
              mat-menu-item
              (click)="runElection()"
              [disabled]="runningNow">
              <mat-icon>play_arrow</mat-icon>
              <span>{{ runningNow ? 'Running…' : 'Run election' }}</span>
            </button>
            <button
              mat-menu-item
              (click)="openEditDialog(election)"
              [disabled]="saving">
              <mat-icon>edit</mat-icon>
              <span>{{ saving ? 'Saving…' : 'Edit election' }}</span>
            </button>
            <button mat-menu-item (click)="confirmDelete(election)">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          } @else {
            <button
              mat-menu-item
              (click)="openReopenDialog(election)"
              [disabled]="reopening">
              <mat-icon>restart_alt</mat-icon>
              <span>{{ reopening ? 'Reopening…' : 'Reopen' }}</span>
            </button>
            <button mat-menu-item (click)="confirmDelete(election)">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          }
        </mat-menu>
      }
    </mat-toolbar>

    @if (loadingElection || loadingCandidates || (closed && loadingResults)) {
      <div class="loading-bar">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    }

    @if (closed) {
      <section class="results-layout">
        @if (ballotLocked && election.status !== 'CLOSED') {
          <div class="result-banner awaiting">Awaiting tabulation…</div>
        }

        @if (!latest && !loadingResults) {
          <div class="result-placeholder">No results recorded yet.</div>
        }

        @if (latest) {
          @let currentLatest = latest!;
          <mat-card class="result-card">
            <mat-card-header>
              <mat-card-title>Latest result</mat-card-title>
              @if (currentLatest.closureTime) {
                <mat-chip class="timestamp-chip">
                  <mat-icon matChipAvatar>schedule</mat-icon>
                  {{ currentLatest.closureTime | date: 'short' }}
                </mat-chip>
              }
            </mat-card-header>
            <mat-card-content>
              <div class="result-meta">
                <div>
                  <span class="label">Winner</span>
                  <span class="value">
                    {{ resolveCandidateName(currentLatest.winnerId ?? null) }}
                  </span>
                </div>
                <div>
                  <span class="label">Total votes</span>
                  <span class="value">{{ currentLatest.totalVotes }}</span>
                </div>
                @if (currentLatest.flags?.length) {
                  <div>
                    <span class="label">Flags</span>
                    <mat-chip-set>
                      <mat-chip *ngFor="let flag of currentLatest.flags">{{
                        flag
                      }}</mat-chip>
                    </mat-chip-set>
                  </div>
                }
              </div>

              @if (currentLatest.rounds?.length) {
                <mat-accordion class="rounds-accordion">
                  @for (
                    round of currentLatest.rounds;
                    track round.roundNumber
                  ) {
                    <mat-expansion-panel>
                      <mat-expansion-panel-header>
                        <mat-panel-title
                          >Round {{ round.roundNumber }}</mat-panel-title
                        >
                        <mat-panel-description>
                          {{
                            formatEliminationMessage(round.eliminationMessage)
                          }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>
                      <div class="round-votes">
                        @for (
                          vote of round.votes | keyvalue: compareVoteEntries;
                          track vote.key
                        ) {
                          <div class="vote-row">
                            <span class="candidate">{{
                              resolveCandidateName(vote.key)
                            }}</span>
                            <span class="tally">{{ vote.value }}</span>
                          </div>
                        }
                      </div>
                      @if (hasEliminated(round)) {
                        <div class="eliminated">
                          Eliminated: {{ formatEliminatedList(round) }}
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                </mat-accordion>
              }
            </mat-card-content>
          </mat-card>
        }

        @if (results?.length ?? 0 > 1) {
          <mat-accordion class="history-accordion" multi>
            @for (
              result of (results ?? []).slice(1);
              track trackByResult($index, result)
            ) {
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Closed {{ result.closureTime | date: 'short' }}
                  </mat-panel-title>
                  <mat-panel-description>
                    Winner: {{ resolveCandidateName(result.winnerId ?? null) }}
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <div class="history-body">
                  <div class="result-meta">
                    <div>
                      <span class="label">Winner</span>
                      <span class="value">
                        {{ resolveCandidateName(result.winnerId ?? null) }}
                      </span>
                    </div>
                    <div>
                      <span class="label">Total votes</span>
                      <span class="value">{{ result.totalVotes }}</span>
                    </div>
                    @if (result.flags?.length) {
                      <div>
                        <span class="label">Flags</span>
                        <mat-chip-set>
                          <mat-chip *ngFor="let flag of result.flags">{{
                            flag
                          }}</mat-chip>
                        </mat-chip-set>
                      </div>
                    }
                  </div>
                  @if (result.rounds?.length) {
                    <div class="history-rounds">
                      @for (round of result.rounds; track round.roundNumber) {
                        <div class="history-round">
                          <div class="round-title">
                            Round {{ round.roundNumber }} ·
                            {{
                              formatEliminationMessage(round.eliminationMessage)
                            }}
                          </div>
                          <div class="round-votes">
                            @for (
                              vote of round.votes
                                | keyvalue: compareVoteEntries;
                              track vote.key
                            ) {
                              <div class="vote-row">
                                <span class="candidate">
                                  {{ resolveCandidateName(vote.key) }}
                                </span>
                                <span class="tally">{{ vote.value }}</span>
                              </div>
                            }
                          </div>
                          @if (hasEliminated(round)) {
                            <div class="eliminated">
                              Eliminated: {{ formatEliminatedList(round) }}
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              </mat-expansion-panel>
            }
          </mat-accordion>
        }
      </section>
    } @else {
      @if (ranked$ | async; as ranked) {
        @if (unranked$ | async; as unranked) {
          <div class="ballot-layout" [class.locked]="ballotLocked">
            <section class="candidate-pane">
              <h3>Nominees</h3>
              @if (unranked.length === 0) {
                <div class="placeholder">No nominations</div>
              }
              @if (unranked.length > 0) {
                <div class="candidates">
                  @for (c of unranked; track trackByCandidate($index, c)) {
                    <mat-card class="candidate-card">
                      <div class="card-body">
                        <app-book-cover
                          class="cover"
                          [src]="c.base.imageURL"
                          [alt]="c.base.title + ' cover'"></app-book-cover>
                        <div class="meta">
                          <div class="book-title">{{ c.base.title }}</div>
                          <div class="book-author">{{ c.base.author }}</div>
                        </div>
                        <div class="spacer"></div>
                        <button
                          mat-icon-button
                          aria-label="View blurb"
                          (click)="openBlurb(c); $event.stopPropagation()"
                          matTooltip="View blurb">
                          <mat-icon>info</mat-icon>
                        </button>
                        <button
                          mat-icon-button
                          class="add-btn"
                          aria-label="Add to ballot"
                          (click)="
                            addToRanked(c.id, ranked); $event.stopPropagation()
                          "
                          matTooltip="Add to ballot">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                    </mat-card>
                  }
                </div>
              }
            </section>

            <section class="ballot-pane">
              <h3>Your Ballot</h3>
              <div class="ballot-controls gap-2">
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="submitBallot()"
                  [disabled]="submittingNow || ranked.length === 0">
                  <mat-icon>how_to_vote</mat-icon>
                  {{ submittingNow ? 'Saving…' : 'Save' }}
                </button>
                <button
                  mat-button
                  color="warn"
                  (click)="resetBallot()"
                  [disabled]="ranked.length === 0">
                  <mat-icon>restart_alt</mat-icon>
                  Reset
                </button>
              </div>
              <div
                cdkDropList
                class="ballot-list"
                (cdkDropListDropped)="dropRanked($event, ranked)">
                @if (ranked.length === 0) {
                  <div class="empty">Tap nominees to add them here.</div>
                }
                @for (
                  c of ranked;
                  track trackByCandidate(i, c);
                  let i = $index
                ) {
                  <div class="ballot-item" cdkDrag>
                    <div class="rank">{{ i + 1 }}</div>
                    <div class="handle" cdkDragHandle>
                      <mat-icon>drag_indicator</mat-icon>
                    </div>
                    <button
                      mat-icon-button
                      aria-label="View blurb"
                      (click)="openBlurb(c); $event.stopPropagation()"
                      matTooltip="View blurb">
                      <mat-icon>info</mat-icon>
                    </button>
                    <div class="meta">
                      <div class="book-title">{{ c.base.title }}</div>
                      <div class="book-author">{{ c.base.author }}</div>
                    </div>
                    <div class="mobile-reorder">
                      <button
                        mat-icon-button
                        aria-label="Move up"
                        (click)="moveUp(i, ranked)">
                        <mat-icon>arrow_upward</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        aria-label="Move down"
                        (click)="moveDown(i, ranked)">
                        <mat-icon>arrow_downward</mat-icon>
                      </button>
                    </div>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="removeFromRanked(c.id, ranked)"
                      aria-label="Remove">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            </section>
          </div>
        }
      }
    }
  </div>
}
