<ng-container *ngIf="viewModel$ | async as vm; else loading">
  <div class="detail-shell">
    <p-toolbar class="top-toolbar">
      <div class="p-toolbar-group-start">
        <button
          pButton
          type="button"
          icon="pi pi-arrow-left"
          class="p-button-text p-button-rounded"
          routerLink="/elections"
          aria-label="Back to elections"
        ></button>
        <span class="title">{{ vm.election?.title }}</span>
      </div>
      <div class="p-toolbar-group-end">
        <p-tag
          *ngIf="vm.election as election"
          [value]="statusTag(election).label"
          [severity]="statusTag(election).severity"
          pTooltip="{{ statusTag(election).description || '' }}"
        ></p-tag>
      </div>
    </p-toolbar>

    <div class="summary-card">
      <div class="meta">
        <div class="meta-item" *ngIf="vm.election?.endDateTime as closes">
          <span class="label">Closes</span>
          <span class="value">{{ closes | date: 'medium' }}</span>
        </div>
        <div class="meta-item" *ngIf="vm.latest as latest">
          <span class="label">Latest run</span>
          <span class="value">{{ latest.closureTime | date: 'medium' }}</span>
        </div>
      </div>
      <div class="summary-actions">
        <p-button
          type="button"
          label="Nominate"
          icon="pi pi-star"
          class="p-button-outlined"
          (onClick)="openNominateDialog()"
          [disabled]="vm.ballotLocked"
        ></p-button>
        <p-button
          type="button"
          label="Run election"
          icon="pi pi-play"
          (onClick)="runElection()"
          [disabled]="vm.running || vm.ballotLocked"
        ></p-button>
        <p-button
          type="button"
          label="Edit"
          icon="pi pi-pencil"
          class="p-button-text"
          (onClick)="openEditDialog(vm.election || null)"
          [disabled]="vm.saving"
        ></p-button>
        <p-button
          *ngIf="vm.isClosed"
          type="button"
          label="Reopen"
          icon="pi pi-refresh"
          class="p-button-text"
          (onClick)="openReopenDialog(vm.election || null)"
          [disabled]="vm.reopening"
        ></p-button>
        <p-button
          type="button"
          label="Delete"
          icon="pi pi-trash"
          class="p-button-text p-button-danger"
          (onClick)="confirmDelete(vm.election!)"
        ></p-button>
      </div>
    </div>

    <div class="content-grid">
      <p-card class="ballot-card" *ngIf="vm.election as election">
        <ng-container *ngIf="vm.showLoading; else ballotBody">
          <div class="loading">
            <p-progressSpinner strokeWidth="3"></p-progressSpinner>
            <span>Loading ballot…</span>
          </div>
        </ng-container>

        <ng-template #ballotBody>
          <div class="ballot-header">
            <div>
              <h3>My ballot</h3>
              <p class="hint" *ngIf="vm.ballotLocked">Ballot is locked until the election reopens.</p>
            </div>
            <div class="ballot-actions">
              <p-button
                type="button"
                label="Submit"
                icon="pi pi-send"
                (onClick)="submitBallot()"
                [disabled]="vm.submitting || vm.ballotLocked || !pending"
                [loading]="vm.submitting"
              ></p-button>
              <p-button
                type="button"
                label="Reset"
                icon="pi pi-undo"
                class="p-button-text"
                (onClick)="resetBallot()"
                [disabled]="vm.ballotLocked"
              ></p-button>
              <p-button
                type="button"
                label="Clear"
                icon="pi pi-times"
                class="p-button-text"
                (onClick)="clearBallot()"
                [disabled]="vm.ballotLocked"
              ></p-button>
            </div>
          </div>

          <div class="ranked-list" *ngIf="vm.ranked.length; else emptyBallot">
            <div class="ranked-item" *ngFor="let candidate of vm.ranked; let idx = index">
              <div class="position">#{{ idx + 1 }}</div>
              <div class="candidate">
                <h4>{{ candidate.base.title }}</h4>
                <p>{{ candidate.base.author }}</p>
              </div>
              <div class="candidate-actions">
                <p-button
                  type="button"
                  icon="pi pi-chevron-up"
                  class="p-button-text"
                  (onClick)="moveUp(idx, vm.ranked)"
                  [disabled]="idx === 0 || vm.ballotLocked"
                ></p-button>
                <p-button
                  type="button"
                  icon="pi pi-chevron-down"
                  class="p-button-text"
                  (onClick)="moveDown(idx, vm.ranked)"
                  [disabled]="idx === vm.ranked.length - 1 || vm.ballotLocked"
                ></p-button>
                <p-button
                  type="button"
                  icon="pi pi-eye"
                  class="p-button-text"
                  (onClick)="openBookDetail(candidate)"
                ></p-button>
                <p-button
                  type="button"
                  icon="pi pi-times"
                  class="p-button-text p-button-danger"
                  (onClick)="removeFromRanked(candidate, vm.ranked)"
                  [disabled]="vm.ballotLocked"
                ></p-button>
              </div>
            </div>
          </div>

          <ng-template #emptyBallot>
            <div class="empty-state">No candidates ranked yet.</div>
          </ng-template>
        </ng-template>
      </p-card>

      <p-card class="available-card">
        <h3>Available candidates</h3>
        <div class="available-list" *ngIf="vm.unranked.length; else noOptions">
          <div class="available-item" *ngFor="let candidate of vm.unranked">
            <div class="info">
              <h4>{{ candidate.base.title }}</h4>
              <p>{{ candidate.base.author }}</p>
            </div>
            <div class="buttons">
              <p-button
                type="button"
                icon="pi pi-plus"
                class="p-button-text"
                (onClick)="addToRanked(candidate, vm.ranked)"
                [disabled]="vm.ballotLocked"
              ></p-button>
              <p-button
                type="button"
                icon="pi pi-eye"
                class="p-button-text"
                (onClick)="openBlurb(candidate)"
                [disabled]="!candidate.base.blurb"
              ></p-button>
            </div>
          </div>
        </div>
        <ng-template #noOptions>
          <div class="empty-state">All candidates ranked.</div>
        </ng-template>
      </p-card>

      <p-card class="results-card">
        <h3>Results</h3>
        <div class="loading" *ngIf="vm.loadingResults">
          <p-progressSpinner strokeWidth="3"></p-progressSpinner>
          <span>Loading results…</span>
        </div>
        <ng-container *ngIf="!vm.loadingResults">
          <div *ngIf="vm.latest as latest" class="latest-result">
            <p-tag value="Latest" severity="success"></p-tag>
            <h4>{{ resolveCandidateName(latest.winnerId ?? null) }}</h4>
            <p class="timestamp" *ngIf="latest.closureTime">
              {{ latest.closureTime | date: 'medium' }}
            </p>
          </div>

          <div class="history" *ngIf="vm.results.length > 0">
            <h5>Round history</h5>
            <div class="round" *ngFor="let result of vm.results">
              <div class="round-header">
                <span>Round {{ result.round ?? 0 }}</span>
                <span>{{ result.closureTime | date: 'short' }}</span>
              </div>
              <div class="round-body">
                <div>
                  <span class="label">Winner</span>
                  <span class="value">{{ resolveCandidateName(result.winnerId ?? null) }}</span>
                </div>
                <div>
                  <span class="label">Eliminated</span>
                  <span class="value">{{ formatEliminatedList(result.roundResult) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-state" *ngIf="!vm.latest && vm.results.length === 0">
            No results recorded yet.
          </div>
        </ng-container>
      </p-card>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div class="loading loading-page">
    <p-progressSpinner strokeWidth="3"></p-progressSpinner>
    <span>Loading election…</span>
  </div>
</ng-template>
