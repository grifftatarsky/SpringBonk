@let state = vm();
<div class="grid pb-24 text-gray-950 sm:gap-40 md:pb-40 dark:text-white">
  <div class="px-2 max-sm:px-4 mt-4">
    <section
      class="rounded-3xl border border-sky-400/30 bg-black/85 px-4 py-10 text-white shadow-[0_0_40px_rgba(56,189,248,0.3)] sm:px-8">
      <p class="text-xs font-semibold uppercase tracking-[0.5em] text-sky-300">Elections</p>
      <h1 class="mt-3 text-3xl font-semibold tracking-tight sm:text-4xl">Preferential control
        room</h1>
      <p class="mt-4 max-w-3xl text-sm text-white/70">
        Filter the roster, spin up new ballots, and jump into detail views with a single tap.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <button type="button"
                class="inline-flex items-center gap-2 rounded-full border border-sky-300/60 bg-sky-500/10 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-sky-100 hover:bg-sky-500/20"
                (click)="openCreateModal()">
          ＋ Schedule election
        </button>
        <a routerLink="/docs"
           fragment="case-study"
           class="inline-flex items-center gap-2 rounded-full border border-white/20 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-white/10">
          Read docs & case study
        </a>
      </div>
    </section>
  </div>
  <div class="px-2 max-sm:px-4 mt-4">
    <section class="rounded-3xl border border-white/10 bg-white/5 px-5 py-6 text-white">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.4em] text-sky-200">Status filter</p>
        </div>
        <div class="flex flex-wrap gap-2">
          @for (filter of statusFilters; track filter.value) {
            <button type="button"
                    class="rounded-full border px-4 py-1 text-xs font-semibold uppercase tracking-[0.3em] transition"
                    [ngClass]="{
                  'border-sky-400 text-sky-200 bg-sky-500/10': state.status === filter.value,
                  'border-white/15 text-white/70 hover:bg-white/10': state.status !== filter.value,
                }"
                    (click)="setStatus(filter.value)">
              {{ filter.label }}
            </button>
          }
        </div>
      </div>
    </section>
  </div>
  <div class="px-2 max-sm:px-4 mt-4">
    <div>
      <app-paginated-list
        title="All elections"
        [page]="state.page"
        [filterValue]="state.filter"
        filterPlaceholder="Search election titles"
        [busy]="state.busy"
        [hasItems]="!!state.items.length"
        [emptyMessage]="state.filter ? 'No elections match your search.' : 'No elections yet — schedule one above.'"
        [showPageSize]="true"
        [pageSizeOptions]="[4, 8, 12]"
        (filterValueChange)="setFilter($event)"
        (pageChange)="changePage($event)"
        (pageSizeChange)="changePageSize($event)">

        <div list-actions
             class="flex w-full flex-col gap-3 text-white/80 sm:flex-row sm:items-center sm:justify-between">
      <span
        class="inline-flex items-center gap-2 rounded-full border border-white/10 px-4 py-1 text-xs uppercase tracking-[0.4em] text-white/60">
        Showing {{ statusFilterLabel(state.status) }}
      </span>
          <button type="button"
                  class="inline-flex items-center gap-2 rounded-full border border-sky-400/40 bg-sky-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-sky-100 hover:bg-sky-500/20"
                  (click)="openCreateModal()">
            ＋ New election
          </button>
        </div>

        <ul class="flex flex-col gap-4">
          @for (election of state.items; track election.id) {
            <li>
              <article
                class="rounded-3xl border border-white/10 bg-black/45 px-5 py-4 text-white shadow-[0_0_20px_rgba(56,189,248,0.15)]">
                <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                  <div>
                    <div
                      class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.4em]">
                  <span class="rounded-full border px-3 py-0.5"
                        [ngClass]="{
                          'border-emerald-300/40 text-emerald-100': election.badgeTone === 'emerald',
                          'border-amber-300/40 text-amber-100': election.badgeTone === 'amber',
                          'border-sky-300/40 text-sky-100': election.badgeTone === 'sky',
                        }">
                    {{ formatStatusLabel(election.status) }}
                  </span>
                      <span class="text-white/60">
                    {{ election.metaLabel }}
                        @if (election.metaDate) {
                          <span>· {{ election.metaDate | date: 'medium' }}</span>
                        }
                  </span>
                    </div>
                    <h3 class="mt-2 text-2xl font-semibold tracking-tight">{{ election.title }}</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <a [routerLink]="['/elections', election.id]"
                       class="inline-flex items-center gap-2 rounded-full border border-white/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-white/10">
                      Open
                    </a>
                    <div class="relative">
                      <button type="button"
                              class="rounded-full border border-white/15 p-2 text-white hover:bg-white/10"
                              aria-label="Election actions"
                              (click)="toggleMenu(election.id)">
                        ⋮
                      </button>
                      @if (isMenuOpen(election.id)) {
                        <div
                          class="absolute right-0 max-sm:-right-16 top-4 z-20 mt-2 w-48 rounded-2xl border border-white/10 bg-gray-950 p-2 text-sm shadow-xl">
                          <button type="button"
                                  class="w-full rounded-xl px-3 py-2 text-left text-white hover:bg-white/10"
                                  (click)="openEditModal(election)">
                            Edit details
                          </button>
                          @if (election.status === 'OPEN' || election.status === 'INDEFINITE') {
                            <button type="button"
                                    class="mt-1 w-full rounded-xl px-3 py-2 text-left text-amber-200 hover:bg-amber-500/10"
                                    (click)="closeElection(election.id)">
                              Close election
                            </button>
                          }
                          @if (election.status === 'CLOSED') {
                            <button type="button"
                                    class="mt-1 w-full rounded-xl px-3 py-2 text-left text-sky-200 hover:bg-sky-500/10"
                                    (click)="openEditModal(election, 'reopen')">
                              Reopen election
                            </button>
                          }
                          <button type="button"
                                  class="mt-1 w-full rounded-xl px-3 py-2 text-left text-red-200 hover:bg-red-500/10"
                                  (click)="deleteElection(election.id)">
                            Delete
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </article>
            </li>
          }
        </ul>
      </app-paginated-list>

      @if (state.error) {
        <p
          class="mt-3 rounded-2xl border border-red-400/40 bg-red-500/10 px-4 py-3 text-sm text-red-200"
          role="status">
          {{ state.error }}
        </p>
      }
    </div>
  </div>

  @if (createModalOpen()) {
    <div class="fixed inset-0 z-40 flex items-center justify-center px-4">
      <div class="absolute inset-0 bg-black/70" (click)="closeCreateModal()"
           aria-hidden="true"></div>
      <section
        class="relative z-10 w-full max-w-xl rounded-3xl border border-sky-400/30 bg-gray-950 px-6 py-6 text-white shadow-[0_0_40px_rgba(56,189,248,0.35)]"
        role="dialog"
        aria-modal="true">
        <header class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">Create election</h2>
          <button type="button" class="text-sm text-white/70 hover:text-white"
                  (click)="closeCreateModal()">Close
          </button>
        </header>
        <form class="mt-6 flex flex-col gap-4" [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <label class="text-xs uppercase tracking-[0.4em] text-white/60">
            Title
            <input type="text" formControlName="title"
                   class="mt-2 w-full rounded-2xl border border-white/15 bg-black/50 px-4 py-3 text-white focus:border-sky-400 focus:outline-none" />
          </label>
          <label class="text-xs uppercase tracking-[0.4em] text-white/60">
            End date (optional)
            <input type="datetime-local" formControlName="endDateTime"
                   class="mt-2 w-full rounded-2xl border border-white/15 bg-black/50 px-4 py-3 text-white focus:border-sky-400 focus:outline-none" />
          </label>
          @if (createState().error) {
            <p
              class="rounded-2xl border border-red-400/40 bg-red-500/10 px-3 py-2 text-sm text-red-200"
              role="alert">
              {{ createState().error }}
            </p>
          }
          <div class="flex justify-end gap-3">
            <button type="button"
                    class="rounded-full border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-white/10"
                    (click)="closeCreateModal()">Cancel
            </button>
            <button type="submit"
                    class="rounded-full border border-sky-400/60 bg-sky-500/10 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-sky-100 hover:bg-sky-500/20 disabled:cursor-not-allowed disabled:opacity-60"
                    [disabled]="createState().busy || createForm.invalid">
              {{ createState().busy ? 'Creating…' : 'Create election' }}
            </button>
          </div>
        </form>
      </section>
    </div>
  }

  @if (editModalOpen()) {
    <div class="fixed inset-0 z-40 flex items-center justify-center px-4">
      <div class="absolute inset-0 bg-black/70" (click)="closeEditModal()" aria-hidden="true"></div>
      <section
        class="relative z-10 w-full max-w-xl rounded-3xl border border-sky-400/30 bg-gray-950 px-6 py-6 text-white shadow-[0_0_40px_rgba(56,189,248,0.35)]"
        role="dialog"
        aria-modal="true">
        <header class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">
            {{ editMode() === 'reopen' ? 'Reopen election' : 'Edit election' }}
          </h2>
          <button type="button" class="text-sm text-white/70 hover:text-white"
                  (click)="closeEditModal()">Close
          </button>
        </header>
        <form class="mt-6 flex flex-col gap-4" [formGroup]="editForm" (ngSubmit)="submitEdit()">
          <label class="text-xs uppercase tracking-[0.4em] text-white/60">
            Title
            <input type="text" formControlName="title"
                   class="mt-2 w-full rounded-2xl border border-white/15 bg-black/50 px-4 py-3 text-white focus:border-sky-400 focus:outline-none"
                   [readonly]="editMode() === 'reopen'" />
          </label>
          <label class="text-xs uppercase tracking-[0.4em] text-white/60">
            End date
            <input type="datetime-local" formControlName="endDateTime"
                   class="mt-2 w-full rounded-2xl border border-white/15 bg-black/50 px-4 py-3 text-white focus:border-sky-400 focus:outline-none" />
          </label>
          @if (editState().error) {
            <p
              class="rounded-2xl border border-red-400/40 bg-red-500/10 px-3 py-2 text-sm text-red-200"
              role="alert">
              {{ editState().error }}
            </p>
          }
          <div class="flex justify-end gap-3">
            <button type="button"
                    class="rounded-full border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-white/10"
                    (click)="closeEditModal()">Cancel
            </button>
            <button type="submit"
                    class="rounded-full border border-sky-400/60 bg-sky-500/10 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-sky-100 hover:bg-sky-500/20 disabled:cursor-not-allowed disabled:opacity-60"
                    [disabled]="editState().busy || editForm.invalid">
              {{
                editState().busy ? 'Saving…' : editMode() === 'reopen' ? 'Reopen' : 'Save changes'
              }}
            </button>
          </div>
        </form>
      </section>
    </div>
  }

</div>
