#!/bin/bash
set -e

# Create the SPRINGBONK database and user
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
   CREATE DATABASE "${SPRINGBONK_DB_NAME}";
   CREATE USER "${SPRINGBONK_DB_USER}" WITH PASSWORD '${SPRINGBONK_DB_PASSWORD}';
   GRANT ALL PRIVILEGES ON DATABASE "${SPRINGBONK_DB_NAME}" TO "${SPRINGBONK_DB_USER}";
EOSQL

# Grant privileges for the SPRINGBONK user on the database schema
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -d "${SPRINGBONK_DB_NAME}" <<-EOSQL
   CREATE SCHEMA IF NOT EXISTS public AUTHORIZATION "${SPRINGBONK_DB_USER}";
   GRANT ALL PRIVILEGES ON SCHEMA public TO "${SPRINGBONK_DB_USER}";
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO "${SPRINGBONK_DB_USER}";
EOSQL

# Create the KEYCLOAK database and user
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
   CREATE DATABASE "${KEYCLOAK_DB_NAME}";
   CREATE USER "${KEYCLOAK_DB_USER}" WITH PASSWORD '${KEYCLOAK_DB_PASSWORD}';
   GRANT ALL PRIVILEGES ON DATABASE "${KEYCLOAK_DB_NAME}" TO "${KEYCLOAK_DB_USER}";
EOSQL

# Grant privileges for the KEYCLOAK user on the database schema
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -d "${KEYCLOAK_DB_NAME}" <<-EOSQL
   CREATE SCHEMA IF NOT EXISTS public AUTHORIZATION "${KEYCLOAK_DB_USER}";
   GRANT ALL PRIVILEGES ON SCHEMA public TO "${KEYCLOAK_DB_USER}";
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO "${KEYCLOAK_DB_USER}";
EOSQL